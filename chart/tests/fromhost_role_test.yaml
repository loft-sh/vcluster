suite: Role (from host)
templates:
  - fromhost_role.yaml

tests:
  - it: check disabled
    set:
      sync:
        fromHost:
          configMaps:
            enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: check enabled but no mappings
    set:
      sync:
        fromHost:
          configMaps:
            enabled: true
            selector:
              mappings: {}

    asserts:
      - hasDocuments:
          count: 0

  - it: check enabled with mappings
    release:
      namespace: default-vcluster
    set:
      sync:
        fromHost:
          configMaps:
            selector:
              mappings:
                "*": "my-ns/*"
                my-ns/*: "my-ns-2/*"
            enabled: true
    asserts:
      - hasDocuments:
          count: 4 # 2 Roles & 2 RoleBindings
      - documentIndex: 0
        equal:
          path: kind
          value: Role
      - documentIndex: 0
        equal:
          path: metadata.namespace
          value: default-vcluster
      - documentIndex: 0
        equal:
          path: rules[0].apiGroups
          value: [""]
      - documentIndex: 0
        equal:
          path: rules[0].resources[0]
          value: "configmaps"
      - documentIndex: 0
        equal:
          path: rules[0].verbs
          value: ["get", "list", "watch"]
      - documentIndex: 1
        equal:
          path: kind
          value: RoleBinding
      - documentIndex: 1
        equal:
          path: metadata.namespace
          value: default-vcluster
      - documentIndex: 1
        equal:
          path: roleRef.name
          value: vc-RELEASE-NAME-from-host
      - documentIndex: 1
        equal:
          path: subjects[0].kind
          value: ServiceAccount
      - documentIndex: 1
        equal:
          path: subjects[0].name
          value: vc-RELEASE-NAME
      - documentIndex: 1
        equal:
          path: subjects[0].namespace
          value: default-vcluster

      - documentIndex: 2
        equal:
          path: kind
          value: Role
      - documentIndex: 2
        equal:
          path: metadata.namespace
          value: my-ns
      - documentIndex: 2
        equal:
          path: rules[0].apiGroups
          value: [ "" ]
      - documentIndex: 2
        equal:
          path: rules[0].resources[0]
          value: "configmaps"
      - documentIndex: 2
        equal:
          path: rules[0].verbs
          value: [ "get", "list", "watch" ]
      - documentIndex: 3
        equal:
          path: kind
          value: RoleBinding
      - documentIndex: 3
        equal:
          path: metadata.namespace
          value: my-ns
      - documentIndex: 3
        equal:
          path: roleRef.name
          value: vc-RELEASE-NAME-from-host
      - documentIndex: 3
        equal:
          path: subjects[0].kind
          value: ServiceAccount
      - documentIndex: 3
        equal:
          path: subjects[0].name
          value: vc-RELEASE-NAME
      - documentIndex: 3
        equal:
          path: subjects[0].namespace
          value: default-vcluster
