suite: NetworkPolicy
templates:
  - networkpolicy.yaml

tests:
  - it: should not create network policy by default
    asserts:
      - hasDocuments:
          count: 0

  - it: check defaults
    release:
      name: my-release
      namespace: my-namespace
    set:
      policies:
        networkPolicy:
          enabled: true
    asserts:
      - hasDocuments:
          count: 4
      - documentIndex: 0
        equal:
          path: metadata.name
          value: vc-work-my-release
      - documentIndex: 0
        equal:
          path: metadata.namespace
          value: my-namespace
      - documentIndex: 0
        equal:
          path: spec.policyTypes
          value: ["Egress", "Ingress"]
      - documentIndex: 0
        lengthEqual:
          path: spec.egress
          count: 3
      - documentIndex: 0
        lengthEqual:
          path: spec.ingress
          count: 2
      - documentIndex: 0
        equal:
          path: spec.egress[2].to[0].ipBlock.cidr
          value: 0.0.0.0/0
      - documentIndex: 1
        equal:
          path: metadata.name
          value: vc-cp-my-release
      - documentIndex: 1
        equal:
          path: metadata.namespace
          value: my-namespace
      - documentIndex: 1
        equal:
          path: spec.policyTypes
          value: ["Egress", "Ingress"]
      - documentIndex: 1
        lengthEqual:
          path: spec.egress
          count: 5
      - documentIndex: 1
        lengthEqual:
          path: spec.ingress
          count: 4
      - documentIndex: 2
        equal:
          path: metadata.name
          value: vc-kube-dns-my-release
      - documentIndex: 2
        equal:
          path: metadata.namespace
          value: my-namespace
      - documentIndex: 2
        equal:
          path: spec.policyTypes
          value: ["Egress", "Ingress"]
      - documentIndex: 2
        lengthEqual:
          path: spec.egress
          count: 2
      - documentIndex: 2
        lengthEqual:
          path: spec.ingress
          count: 1

  - it: should support extra ingress/egress rules
    release:
      name: my-release
      namespace: my-namespace
    set:
      policies:
        networkPolicy:
          enabled: true
          controlPlane:
            ingress:
              - ports:
                  - port: 12340
            egress:
              - ports:
                  - port: 1234
          workload:
            ingress:
              - ports:
                  - port: 23450
            egress:
              - ports:
                  - port: 2345
    asserts:
      - hasDocuments:
          count: 4
      - documentIndex: 0
        equal:
          path: spec.egress[3].ports[0].port
          value: 2345
      - documentIndex: 0
        equal:
          path: spec.ingress[2].ports[0].port
          value: 23450
      - documentIndex: 1
        equal:
          path: spec.egress[5].ports[0].port
          value: 1234
      - documentIndex: 1
        equal:
          path: spec.ingress[4].ports[0].port
          value: 12340
